[Unit]
Description=etcd-netfw green backend for tentacle-server
Wants=docker.service
After=docker.service

[Service]
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker kill octoblu-tentacle-server-etcd-netfw-backend-green
ExecStartPre=-/usr/bin/docker rm octoblu-tentacle-server-etcd-netfw-backend-green
ExecStartPre=/usr/bin/docker pull octoblu/etcd-netfw
ExecStart=/usr/bin/sh -c "/usr/bin/docker run \
  --rm \
  --name octoblu-tentacle-server-etcd-netfw-backend-green \
  -p $(etcdctl get octoblu/tentacle-server/green/backend_port):1337 \
  octoblu/etcd-netfw \
    -etcdAddress=http://$(ifconfig docker0 | grep 'inet ' | awk '{print $2}'):2379 \
    -servicePath=/octoblu/tentacle-server/etcd-netfw/backends/green \
"
ExecStop=/usr/bin/docker kill octoblu-tentacle-server-etcd-netfw-backend-green

[X-Fleet]
Global=true
MachineMetadata=Services=true
